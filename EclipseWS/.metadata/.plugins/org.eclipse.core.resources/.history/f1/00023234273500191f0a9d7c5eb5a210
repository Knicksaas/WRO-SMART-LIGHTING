package ch.nte.wro.linefollower;

import ch.nte.wro.sensors.LightIntensitySensorChecker;
import ch.nte.wro.status.GlobalSensors;
import ch.nte.wro.status.RoboData;
import lejos.robotics.RegulatedMotor;

public class Linefollower {
	
	private int speed;
	private RegulatedMotor mLeft;
	private RegulatedMotor mRight;
	private boolean running = true;
	private float kp;
	private float ki;
	private float outI = 0;
	
	public Linefollower(int speed, RegulatedMotor mLeft, RegulatedMotor mRight, float kp, float ki) {
		this.speed = speed;
		this.mLeft = mLeft;
		this.mRight = mRight;
		this.kp = kp;
		this.ki = ki;
		followLine();
	}
	
	private void followLine() {
		
		LightIntensitySensorChecker lLeft = new LightIntensitySensorChecker(GlobalSensors.colorSensorLeft);
		
		mLeft.setSpeed(speed);
		mRight.setSpeed(speed);
		if(RoboData.invertMotorDirection) {
			mLeft.backward();
			mRight.backward();
			mLeft.setSpeed(speed);
			mRight.setSpeed(speed);
		} else {
			mLeft.forward();
			mRight.forward();
			mLeft.setSpeed(speed);
			mRight.setSpeed(speed);
		}
		
		while(running) {
			lLeft.checkSensor();
			
			float outP = (0.42F - lLeft.getIntensity())*kp;
			 outI = outI + (0.42F - lLeft.getIntensity())*ki;
			
			int out = Math.round(outP + outI);
			
			if(out > 0) {
				mRight.setSpeed(out);
				mLeft.setSpeed(speed);
				//Evtl delay
			} else {
				mLeft.setSpeed(out);
				mRight.setSpeed(speed);
				//Evtl delay
			}
			
		}
	}
}
